version: '3'

vars:
  API_DIR: ./api
  WEB_DIR: ./web
  DOCS_DIR: ./docs
  DOCS_PORT: '{{.DOCS_PORT | default "4001"}}'
  # External repos (sibling directories)
  DEMOS_DIR: ../refyne-demos
  SDK_GO_DIR: ../refyne-sdk-go
  SDK_PYTHON_DIR: ../refyne-sdk-python
  SDK_RUST_DIR: ../refyne-sdk-rust
  SDK_TS_DIR: ../refyne-sdk-ts
  # Demo app ports
  RECIPEAPP_PORT: '{{.RECIPEAPP_PORT | default "4002"}}'
  DIYVIEWER_PORT: '{{.DIYVIEWER_PORT | default "4003"}}'
  VERSION_PKG: github.com/jmylchreest/refyne-api/internal/version
  VERSION:
    sh: git describe --tags --always --dirty 2>/dev/null || echo "0.0.0-dev"
  COMMIT:
    sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
  DATE:
    sh: date -u +"%Y-%m-%dT%H:%M:%SZ"
  DIRTY:
    sh: git diff --quiet 2>/dev/null && echo "false" || echo "true"
  LDFLAGS: >-
    -X {{.VERSION_PKG}}.Version={{.VERSION}}
    -X {{.VERSION_PKG}}.Commit={{.COMMIT}}
    -X {{.VERSION_PKG}}.Date={{.DATE}}
    -X {{.VERSION_PKG}}.Dirty={{.DIRTY}}

tasks:
  # API tasks
  api:deps:
    desc: Download Go dependencies
    dir: '{{.API_DIR}}'
    cmds:
      - go mod tidy
      - go mod download

  api:build:
    desc: Build the API with version info
    dir: '{{.API_DIR}}'
    env:
      CGO_ENABLED: "1"
    cmds:
      - go build -ldflags "{{.LDFLAGS}}" -o ../bin/refyne-api ./cmd/refyne-api

  api:build-prod:
    desc: Build optimized API binary for production
    dir: '{{.API_DIR}}'
    env:
      CGO_ENABLED: "0"
    cmds:
      - go build -trimpath -ldflags "-s -w {{.LDFLAGS}}" -o ../bin/refyne-api ./cmd/refyne-api

  api:dev:
    desc: Run API in development mode with hot reload
    dir: '{{.API_DIR}}'
    dotenv: ['.env', '.env.local']
    env:
      CGO_ENABLED: "1"
      LOG_FORMAT: text
      LOG_LEVEL: debug
      DATABASE_URL: file:../refyne-dev.db
      CORS_ORIGINS: http://localhost:3000
    cmds:
      - air

  api:run:
    desc: Run API without hot reload
    dir: '{{.API_DIR}}'
    dotenv: ['.env', '.env.local']
    env:
      CGO_ENABLED: "1"
      LOG_FORMAT: text
      LOG_LEVEL: debug
      DATABASE_URL: file:../refyne-dev.db
      CORS_ORIGINS: http://localhost:3000
    cmds:
      - go run -ldflags "{{.LDFLAGS}}" ./cmd/refyne-api

  api:test:
    desc: Run API tests
    dir: '{{.API_DIR}}'
    cmds:
      - go test -v ./...

  api:lint:
    desc: Lint API code
    dir: '{{.API_DIR}}'
    cmds:
      - golangci-lint run

  # Web tasks
  web:deps:
    desc: Install frontend dependencies
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm install

  web:build:
    desc: Build frontend
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm run build

  web:dev:
    desc: Run frontend in development mode
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm run dev

  web:lint:
    desc: Lint frontend code
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm run lint

  # Docs tasks
  docs:deps:
    desc: Install docs dependencies
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npm install

  docs:dev:
    desc: Run docs site in development mode (default port 4001, override with DOCS_PORT=xxxx)
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npm run dev -- --port {{.DOCS_PORT}}

  docs:build:
    desc: Build docs site
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npm run build

  docs:lint:
    desc: Lint docs code
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npm run lint

  # Database tasks
  db:migrate:
    desc: Run database migrations (happens automatically on startup)
    dir: '{{.API_DIR}}'
    cmds:
      - echo "Migrations run automatically on API startup"

  # Combined tasks
  deps:
    desc: Install all dependencies
    cmds:
      - task: api:deps
      - task: web:deps
      - task: docs:deps

  build:
    desc: Build everything
    cmds:
      - task: api:build
      - task: web:build
      - task: docs:build

  dev:
    desc: Start development servers (run in separate terminals)
    cmds:
      - echo "Run 'task api:dev' in one terminal"
      - echo "Run 'task web:dev' in another terminal"
      - echo "Run 'task docs:dev' for docs (port {{.DOCS_PORT}}, override with DOCS_PORT=xxxx)"

  test:
    desc: Run all tests
    cmds:
      - task: api:test

  # Docker tasks
  docker:build:
    desc: Build Docker images
    cmds:
      - docker build -f deployments/docker/Dockerfile.api -t refyne-api:latest .
      - docker build -f deployments/docker/Dockerfile.web -t refyne-web:latest .

  docker:up:
    desc: Start Docker Compose
    cmds:
      - docker-compose -f deployments/docker/docker-compose.yml up -d

  docker:down:
    desc: Stop Docker Compose
    cmds:
      - docker-compose -f deployments/docker/docker-compose.yml down

  # Lint tasks
  lint:
    desc: Run linting across all components (api, web, docs, demo)
    cmds:
      - task: api:lint
      - task: web:lint
      - task: docs:lint
      - task: demo:lint

  demo:dev:
    desc: Run demo site in development mode
    dir: ./demo
    cmds:
      - npm run dev

  demo:build:
    desc: Build demo site
    dir: ./demo
    cmds:
      - npm run build

  demo:preview:
    desc: Preview demo site build
    dir: ./demo
    cmds:
      - npm run preview

  demo:lint:
    desc: Lint demo code
    dir: ./demo
    cmds:
      - npm run lint 2>/dev/null || echo "No lint script configured for demo"

  # ============================================
  # External Demo Apps (../refyne-demos)
  # ============================================
  demos:recipeapp:deps:
    desc: Install recipeapp dependencies
    dir: '{{.DEMOS_DIR}}/recipeapp'
    cmds:
      - npm install

  demos:recipeapp:dev:
    desc: Run recipeapp locally (default port 4002, override with RECIPEAPP_PORT=xxxx)
    dir: '{{.DEMOS_DIR}}/recipeapp'
    cmds:
      - npm run dev -- --port {{.RECIPEAPP_PORT}}

  demos:recipeapp:build:
    desc: Build recipeapp
    dir: '{{.DEMOS_DIR}}/recipeapp'
    cmds:
      - npm run build

  demos:recipeapp:deps:update:
    desc: Update recipeapp dependencies within semver ranges
    dir: '{{.DEMOS_DIR}}/recipeapp'
    cmds:
      - npm update

  demos:recipeapp:deps:upgrade:
    desc: Upgrade recipeapp dependencies to latest versions
    dir: '{{.DEMOS_DIR}}/recipeapp'
    cmds:
      - npx npm-check-updates -u
      - npm install

  demos:diyviewer:deps:
    desc: Install diyviewer dependencies
    dir: '{{.DEMOS_DIR}}/diyviewer'
    cmds:
      - npm install

  demos:diyviewer:dev:
    desc: Run diyviewer locally (default port 4003, override with DIYVIEWER_PORT=xxxx)
    dir: '{{.DEMOS_DIR}}/diyviewer'
    cmds:
      - npm run dev -- --port {{.DIYVIEWER_PORT}}

  demos:diyviewer:build:
    desc: Build diyviewer
    dir: '{{.DEMOS_DIR}}/diyviewer'
    cmds:
      - npm run build

  demos:diyviewer:deps:update:
    desc: Update diyviewer dependencies within semver ranges
    dir: '{{.DEMOS_DIR}}/diyviewer'
    cmds:
      - npm update

  demos:diyviewer:deps:upgrade:
    desc: Upgrade diyviewer dependencies to latest versions
    dir: '{{.DEMOS_DIR}}/diyviewer'
    cmds:
      - npx npm-check-updates -u
      - npm install

  demos:deps:
    desc: Install all demo app dependencies
    cmds:
      - task: demos:recipeapp:deps
      - task: demos:diyviewer:deps

  demos:deps:update:
    desc: Update all demo app dependencies
    cmds:
      - task: demos:recipeapp:deps:update
      - task: demos:diyviewer:deps:update

  demos:deps:upgrade:
    desc: Upgrade all demo app dependencies
    cmds:
      - task: demos:recipeapp:deps:upgrade
      - task: demos:diyviewer:deps:upgrade

  # ============================================
  # SDKs (../refyne-sdk-*)
  # ============================================
  sdk:go:deps:
    desc: Download Go SDK dependencies
    dir: '{{.SDK_GO_DIR}}'
    cmds:
      - go mod tidy
      - go mod download

  sdk:go:deps:update:
    desc: Update Go SDK dependencies within compatible versions
    dir: '{{.SDK_GO_DIR}}'
    cmds:
      - go get -u=patch ./...
      - go mod tidy

  sdk:go:deps:upgrade:
    desc: Upgrade Go SDK dependencies to latest versions
    dir: '{{.SDK_GO_DIR}}'
    cmds:
      - go get -u ./...
      - go mod tidy

  sdk:go:test:
    desc: Run Go SDK tests
    dir: '{{.SDK_GO_DIR}}'
    cmds:
      - go test -v ./...

  sdk:go:generate:
    desc: Regenerate Go SDK from OpenAPI spec
    dir: '{{.SDK_GO_DIR}}'
    cmds:
      - make generate 2>/dev/null || echo "Run 'make generate' in the SDK repo"

  sdk:python:deps:
    desc: Install Python SDK dependencies
    dir: '{{.SDK_PYTHON_DIR}}'
    cmds:
      - uv sync

  sdk:python:deps:update:
    desc: Update Python SDK dependencies
    dir: '{{.SDK_PYTHON_DIR}}'
    cmds:
      - uv lock --upgrade

  sdk:python:deps:upgrade:
    desc: Upgrade Python SDK dependencies to latest versions
    dir: '{{.SDK_PYTHON_DIR}}'
    cmds:
      - uv lock --upgrade
      - uv sync

  sdk:python:test:
    desc: Run Python SDK tests
    dir: '{{.SDK_PYTHON_DIR}}'
    cmds:
      - uv run pytest

  sdk:python:generate:
    desc: Regenerate Python SDK from OpenAPI spec
    dir: '{{.SDK_PYTHON_DIR}}'
    cmds:
      - ./scripts/generate.sh 2>/dev/null || echo "Run './scripts/generate.sh' in the SDK repo"

  sdk:rust:deps:
    desc: Install Rust SDK dependencies
    dir: '{{.SDK_RUST_DIR}}'
    cmds:
      - cargo fetch

  sdk:rust:deps:update:
    desc: Update Rust SDK dependencies within compatible versions
    dir: '{{.SDK_RUST_DIR}}'
    cmds:
      - cargo update --compatible

  sdk:rust:deps:upgrade:
    desc: Upgrade Rust SDK dependencies to latest versions
    dir: '{{.SDK_RUST_DIR}}'
    cmds:
      - cargo update

  sdk:rust:test:
    desc: Run Rust SDK tests
    dir: '{{.SDK_RUST_DIR}}'
    cmds:
      - cargo test

  sdk:rust:generate:
    desc: Regenerate Rust SDK from OpenAPI spec
    dir: '{{.SDK_RUST_DIR}}'
    cmds:
      - make generate 2>/dev/null || ./scripts/generate.sh 2>/dev/null || echo "Run generation script in the SDK repo"

  sdk:ts:deps:
    desc: Install TypeScript SDK dependencies
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - npm install

  sdk:ts:deps:update:
    desc: Update TypeScript SDK dependencies within semver ranges
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - npm update

  sdk:ts:deps:upgrade:
    desc: Upgrade TypeScript SDK dependencies to latest versions
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - npx npm-check-updates -u
      - npm install

  sdk:ts:test:
    desc: Run TypeScript SDK tests
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - npm test

  sdk:ts:build:
    desc: Build TypeScript SDK
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - npm run build

  sdk:ts:generate:
    desc: Regenerate TypeScript SDK from OpenAPI spec
    dir: '{{.SDK_TS_DIR}}'
    cmds:
      - ./scripts/generate.sh 2>/dev/null || echo "Run './scripts/generate.sh' in the SDK repo"

  # Combined SDK tasks
  sdk:deps:
    desc: Install all SDK dependencies
    cmds:
      - task: sdk:go:deps
      - task: sdk:python:deps
      - task: sdk:rust:deps
      - task: sdk:ts:deps

  sdk:deps:update:
    desc: Update all SDK dependencies within compatible versions
    cmds:
      - task: sdk:go:deps:update
      - task: sdk:python:deps:update
      - task: sdk:rust:deps:update
      - task: sdk:ts:deps:update

  sdk:deps:upgrade:
    desc: Upgrade all SDK dependencies to latest versions
    cmds:
      - task: sdk:go:deps:upgrade
      - task: sdk:python:deps:upgrade
      - task: sdk:rust:deps:upgrade
      - task: sdk:ts:deps:upgrade

  sdk:test:
    desc: Run all SDK tests
    cmds:
      - task: sdk:go:test
      - task: sdk:python:test
      - task: sdk:rust:test
      - task: sdk:ts:test

  sdk:generate:
    desc: Regenerate all SDKs from OpenAPI spec
    cmds:
      - task: sdk:go:generate
      - task: sdk:python:generate
      - task: sdk:rust:generate
      - task: sdk:ts:generate

  lint:fix:
    desc: Run linting with auto-fix across all components
    cmds:
      - task: api:lint:fix
      - task: web:lint:fix

  api:lint:fix:
    desc: Lint API code with auto-fix
    dir: '{{.API_DIR}}'
    cmds:
      - golangci-lint run --fix

  web:lint:fix:
    desc: Lint frontend code with auto-fix
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm run lint -- --fix

  # Dependency tasks
  deps:update:
    desc: Update dependencies within compatible versions (safe) - this repo only
    cmds:
      - task: api:deps:update
      - task: web:deps:update
      - task: docs:deps:update
      - task: demo:deps:update

  deps:upgrade:
    desc: Upgrade all dependencies to latest versions (may include breaking changes) - this repo only
    cmds:
      - task: api:deps:upgrade
      - task: web:deps:upgrade
      - task: docs:deps:upgrade
      - task: demo:deps:upgrade

  deps:update:all:
    desc: Update ALL dependencies including external repos (demos, SDKs)
    cmds:
      - task: deps:update
      - task: demos:deps:update
      - task: sdk:deps:update

  deps:upgrade:all:
    desc: Upgrade ALL dependencies including external repos (demos, SDKs)
    cmds:
      - task: deps:upgrade
      - task: demos:deps:upgrade
      - task: sdk:deps:upgrade

  api:deps:update:
    desc: Update Go dependencies within compatible versions (safe)
    dir: '{{.API_DIR}}'
    cmds:
      - go get -u=patch ./...
      - go mod tidy

  api:deps:upgrade:
    desc: Upgrade Go dependencies to latest versions
    dir: '{{.API_DIR}}'
    cmds:
      - go get -u ./...
      - go mod tidy

  web:deps:update:
    desc: Update web dependencies within semver ranges (safe)
    dir: '{{.WEB_DIR}}'
    cmds:
      - npm update

  web:deps:upgrade:
    desc: Upgrade web dependencies to latest versions
    dir: '{{.WEB_DIR}}'
    cmds:
      - npx npm-check-updates -u
      - npm install

  docs:deps:update:
    desc: Update docs dependencies within semver ranges (safe)
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npm update

  docs:deps:upgrade:
    desc: Upgrade docs dependencies to latest versions
    dir: '{{.DOCS_DIR}}'
    cmds:
      - npx npm-check-updates -u
      - npm install

  demo:deps:update:
    desc: Update demo dependencies within semver ranges (safe)
    dir: ./demo
    cmds:
      - npm update

  demo:deps:upgrade:
    desc: Upgrade demo dependencies to latest versions
    dir: ./demo
    cmds:
      - npx npm-check-updates -u
      - npm install

  # Cleanup
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf bin/
      - rm -rf web/.next/
      - rm -rf web/node_modules/
      - rm -rf docs/.next/
      - rm -rf docs/node_modules/
      - rm -rf demo/node_modules/
      - rm -rf demo/dist/

  # Version info
  version:
    desc: Show version information
    cmds:
      - echo "Version{{":"}} {{.VERSION}}"
      - echo "Commit{{":"}}  {{.COMMIT}}"
      - echo "Date{{":"}}    {{.DATE}}"
      - echo "Dirty{{":"}}   {{.DIRTY}}"
