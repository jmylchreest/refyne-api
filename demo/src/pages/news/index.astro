---
import Layout from '../../layouts/Layout.astro';
import Card from '../../components/Card.astro';
import Pagination from '../../components/Pagination.astro';
import { getNews, getNewsSources, formatRelativeTime, getSourceColor } from '../../lib/news';

const url = Astro.url;
const source = url.searchParams.get('source') || undefined;
const page = parseInt(url.searchParams.get('page') || '1', 10);
const perPage = 15;

let allNews = await getNews();
const sources = await getNewsSources();

// Apply filter
if (source) {
  allNews = allNews.filter((item) => item.source === source);
}

const totalPages = Math.ceil(allNews.length / perPage);
const news = allNews.slice((page - 1) * perPage, page * perPage);

function getFilterUrl(params: Record<string, string | undefined>): string {
  const searchParams = new URLSearchParams();
  if (params.source) searchParams.set('source', params.source);
  const qs = searchParams.toString();
  return qs ? `/news?${qs}` : '/news';
}
---

<Layout title="News" description="Latest tech news and headlines">
  <!-- Header -->
  <section class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white">
    <div class="container py-12">
      <h1 class="text-3xl md:text-4xl font-bold mb-4">Tech News</h1>
      <p class="text-lg text-indigo-100 max-w-2xl">
        Stay updated with the latest headlines from Hacker News, TechCrunch, and BBC Tech.
      </p>
    </div>
  </section>

  <!-- Filters -->
  <section class="bg-white border-b border-gray-200 sticky top-16 z-40">
    <div class="container py-4">
      <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Source</label>
      <div class="flex flex-wrap gap-2">
        <a
          href={getFilterUrl({})}
          class:list={[
            'px-3 py-1.5 rounded-full text-sm font-medium transition-colors',
            !source ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200',
          ]}
        >
          All Sources
        </a>
        {sources.map((s) => (
          <a
            href={getFilterUrl({ source: s })}
            class:list={[
              'px-3 py-1.5 rounded-full text-sm font-medium transition-colors',
              source === s ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200',
            ]}
          >
            {s}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Results -->
  <section class="py-8">
    <div class="container">
      <div class="flex items-center justify-between mb-6">
        <p class="text-gray-600">
          Showing <span class="font-medium">{news.length}</span> of <span class="font-medium">{allNews.length}</span> articles
        </p>
      </div>

      {news.length > 0 ? (
        <div class="grid gap-4">
          {news.map((item) => (
            <Card href={`/news/${item.id}`}>
              <div class="p-5">
                <div class="flex flex-col md:flex-row md:items-start gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                      <span class={getSourceColor(item.source)}>{item.source}</span>
                      <span class="text-sm text-gray-500">{formatRelativeTime(item.published_at)}</span>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900">{item.title}</h2>
                    {item.summary && (
                      <p class="text-gray-600 mt-2 line-clamp-2">{item.summary}</p>
                    )}
                  </div>
                  <div class="shrink-0">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </div>
              </div>
            </Card>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-gray-500">No news found from this source.</p>
          <a href="/news" class="text-indigo-600 hover:text-indigo-700 font-medium mt-2 inline-block">
            View all sources
          </a>
        </div>
      )}

      <Pagination
        currentPage={page}
        totalPages={totalPages}
        basePath={getFilterUrl({ source })}
      />
    </div>
  </section>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
