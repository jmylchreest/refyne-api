# fly.production.toml - Fly.io configuration for refyne-captcha PRODUCTION service
# Deploy: fly deploy --config fly.production.toml --app refyne-captcha
#
# INTERNAL SERVICE ONLY - Not publicly accessible
# Access via private networking: refyne-captcha.internal:8191
# Only accessible from apps in the same Fly.io organization

app = "refyne-captcha"
primary_region = "lhr"  # London

[build]
  dockerfile = "Dockerfile"

[env]
  PORT = "8191"
  LOG_LEVEL = "info"
  BROWSER_POOL_SIZE = "2"
  SESSION_DB_PATH = ":memory:"       # In-memory SQLite (no persistence needed)
  IDLE_TIMEOUT = "60s"
  SESSION_MAX_IDLE = "10m"
  CHALLENGE_TIMEOUT = "60s"
  ENABLE_PPROF = "true"              # Enable pprof profiler (access via: fly proxy 6060:6060)
  # Secrets set via: fly secrets set KEY=value --app refyne-captcha
  # Required: REFYNE_API_SECRET (shared with refyne-api for HMAC verification)

# Internal-only service - no public ports
# Access via Fly private networking: http://refyne-captcha.internal:8191
# Max machines: fly scale count --max-per-region 3 --app refyne-captcha
[[services]]
  internal_port = 8191
  protocol = "tcp"
  auto_stop_machines = "stop"   # Stop after idle period
  auto_start_machines = true    # Start on incoming request (via private network)
  min_machines_running = 0      # Scale to zero when idle

  # Internal port for private networking
  [[services.ports]]
    port = 8191
    handlers = ["http"]

  # Concurrency limits - browser instances are heavy
  [services.concurrency]
    type = "requests"
    hard_limit = 25
    soft_limit = 20

  # Internal TCP health check
  [[services.tcp_checks]]
    grace_period = "30s"   # Allow time for Chrome to start
    interval = "30s"
    timeout = "10s"

# No persistent volume - using in-memory SQLite for sessions
# Each instance restart loses session state (acceptable for short-lived sessions)

[[vm]]
  memory = "2gb"       # Chrome needs memory
  cpu_kind = "shared"
  cpus = 2
