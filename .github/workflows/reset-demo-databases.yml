name: Reset Demo Databases

on:
  schedule:
    # Daily reset at 4 AM UTC (before 6 AM deploy)
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      reset_recipeapp:
        description: "Reset Recipe App database"
        required: false
        default: true
        type: boolean
      reset_diyviewer:
        description: "Reset DIY Viewer database"
        required: false
        default: true
        type: boolean

jobs:
  reset-recipeapp:
    name: Reset Recipe App Database
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.reset_recipeapp == true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Reset database
        working-directory: demos/recipeapp
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: ./scripts/reset-db.sh ${{ vars.RECIPEAPP_D1_DATABASE }}

  reset-diyviewer:
    name: Reset DIY Viewer Database
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.reset_diyviewer == true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Reset database
        working-directory: demos/diyviewer
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: ./scripts/reset-db.sh ${{ vars.DIYVIEWER_D1_DATABASE }}
