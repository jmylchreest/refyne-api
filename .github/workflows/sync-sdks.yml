# Sync SDK repositories when OpenAPI spec changes
# Triggers each SDK repo to regenerate types from the updated spec
# SDK versions use API major.minor with their own patch version
name: Sync SDKs

on:
  # Trigger after deploy workflow completes successfully
  workflow_run:
    workflows: ["Deploy"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      sdk:
        description: 'SDK to sync (all, ts, go, python, rust)'
        required: false
        default: 'all'

jobs:
  prepare:
    runs-on: ubuntu-latest
    # Only run if deploy succeeded or if manually triggered
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    outputs:
      api_version: ${{ steps.version.outputs.version }}
      api_major: ${{ steps.version.outputs.major }}
      api_minor: ${{ steps.version.outputs.minor }}
      api_patch: ${{ steps.version.outputs.patch }}
      api_sha: ${{ steps.version.outputs.sha }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract API version
        id: version
        uses: jmylchreest/gha-extract-git-version@v1

      - name: Log version info
        run: |
          echo "API Version: ${{ steps.version.outputs.version }}"
          echo "Major: ${{ steps.version.outputs.major }}"
          echo "Minor: ${{ steps.version.outputs.minor }}"
          echo "Patch: ${{ steps.version.outputs.patch }}"

  trigger-sdk-sync:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        sdk: [refyne-sdk-ts, refyne-sdk-go, refyne-sdk-python, refyne-sdk-rust]
    steps:
      - name: Check if SDK should be triggered
        id: check
        run: |
          SDK="${{ matrix.sdk }}"
          INPUT="${{ github.event.inputs.sdk }}"

          # If workflow_dispatch, check if this SDK should run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "$INPUT" = "all" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            elif [ "$INPUT" = "ts" ] && [ "$SDK" = "refyne-sdk-ts" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            elif [ "$INPUT" = "go" ] && [ "$SDK" = "refyne-sdk-go" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            elif [ "$INPUT" = "python" ] && [ "$SDK" = "refyne-sdk-python" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            elif [ "$INPUT" = "rust" ] && [ "$SDK" = "refyne-sdk-rust" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            # workflow_run event (deploy completed) - trigger all
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger SDK workflow
        if: steps.check.outputs.should_run == 'true'
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.SDK_SYNC_TOKEN }}
          repository: jmylchreest/${{ matrix.sdk }}
          event-type: openapi-updated
          client-payload: |
            {
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "api_version": "${{ needs.prepare.outputs.api_version }}",
              "api_major": "${{ needs.prepare.outputs.api_major }}",
              "api_minor": "${{ needs.prepare.outputs.api_minor }}",
              "api_patch": "${{ needs.prepare.outputs.api_patch }}",
              "api_sha": "${{ needs.prepare.outputs.api_sha }}"
            }

      - name: Log trigger
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Triggered sync for ${{ matrix.sdk }}"
          echo "  API Version: ${{ needs.prepare.outputs.api_version }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
