name: Deploy

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

# Cancel in-progress runs for the same ref
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine deployment environment
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      api_app: ${{ steps.env.outputs.api_app }}
      web_project: ${{ steps.env.outputs.web_project }}
      api_url: ${{ steps.env.outputs.api_url }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="production"
          else
            ENV="staging"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT

          if [[ "$ENV" == "production" ]]; then
            echo "api_app=refyne-api" >> $GITHUB_OUTPUT
            echo "web_project=refyne-web" >> $GITHUB_OUTPUT
            echo "api_url=https://api.refyne.uk" >> $GITHUB_OUTPUT
          else
            echo "api_app=refyne-api-staging" >> $GITHUB_OUTPUT
            echo "web_project=refyne-web-staging" >> $GITHUB_OUTPUT
            echo "api_url=https://api-staging.refyne.uk" >> $GITHUB_OUTPUT
          fi

          echo "Deploying to: ${ENV}"

  # Run tests before deployment
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Configure Git for private Go modules
      - name: Configure Git for private modules
        run: git config --global url."https://x-access-token:${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: api/go.sum

      - name: Run API tests
        run: go test -timeout 120s ./...  # TODO: re-enable -race after fixing timeout middleware races
        working-directory: api
        env:
          GOPRIVATE: github.com/jmylchreest/*

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        run: npm ci
        working-directory: web

      - name: Lint web
        run: npm run lint
        working-directory: web

  # Deploy API to Fly.io
  deploy-api:
    name: Deploy API (${{ needs.prepare.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [prepare, test]
    environment:
      name: ${{ needs.prepare.outputs.environment }}
      url: ${{ needs.prepare.outputs.api_url }}
    defaults:
      run:
        working-directory: api

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version detection

      - name: Extract version
        id: version
        uses: jmylchreest/gha-extract-git-version@v1

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        run: |
          flyctl deploy --remote-only \
            --app ${{ needs.prepare.outputs.api_app }} \
            --config fly.${{ needs.prepare.outputs.environment }}.toml \
            --build-secret GH_TOKEN=${{ secrets.GH_PAT }} \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT=${{ steps.version.outputs.sha }} \
            --build-arg DATE=${{ steps.version.outputs.date }} \
            --build-arg DIRTY=${{ steps.version.outputs.dirty }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10
          flyctl status --app ${{ needs.prepare.outputs.api_app }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Deploy Web to Vercel
  deploy-web:
    name: Deploy Web (${{ needs.prepare.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [prepare, test, deploy-api]  # Deploy after API so web can connect
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: ${{ needs.prepare.outputs.environment }}-web
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: web

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=${{ needs.prepare.outputs.environment == 'production' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build with Vercel
        run: vercel build ${{ needs.prepare.outputs.environment == 'production' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          NEXT_PUBLIC_API_URL: ${{ needs.prepare.outputs.api_url }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.CLERK_PUBLISHABLE_KEY }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --archive=tgz ${{ needs.prepare.outputs.environment == 'production' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${URL}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Post-deployment notification (optional)
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, deploy-api, deploy-web]
    if: always() && (needs.deploy-api.result == 'success' || needs.deploy-web.result == 'success')
    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ${{ needs.prepare.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web:** ${{ needs.deploy-web.outputs.url || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.deploy-web.result }} |" >> $GITHUB_STEP_SUMMARY
