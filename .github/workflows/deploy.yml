name: Deploy

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

# Cancel in-progress runs for the same ref
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "stable"
  NODE_VERSION: "20"

jobs:
  # Determine deployment environment
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      api_app: ${{ steps.env.outputs.api_app }}
      web_project: ${{ steps.env.outputs.web_project }}
      api_url: ${{ steps.env.outputs.api_url }}
      web_url: ${{ steps.env.outputs.web_url }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="production"
          else
            ENV="staging"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT

          if [[ "$ENV" == "production" ]]; then
            echo "api_app=refyne-api" >> $GITHUB_OUTPUT
            echo "web_project=refyne-web-production" >> $GITHUB_OUTPUT
            echo "api_url=https://api.refyne.uk" >> $GITHUB_OUTPUT
            echo "web_url=https://refyne.uk" >> $GITHUB_OUTPUT
          else
            echo "api_app=refyne-api-staging" >> $GITHUB_OUTPUT
            echo "web_project=refyne-web-staging" >> $GITHUB_OUTPUT
            echo "api_url=https://api-staging.refyne.uk" >> $GITHUB_OUTPUT
            echo "web_url=https://staging.refyne.uk" >> $GITHUB_OUTPUT
          fi

          echo "Deploying to: ${ENV}"

  # Run tests before deployment
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Configure Git for private Go modules
      - name: Configure Git for private modules
        run: git config --global url."https://x-access-token:${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: api/go.sum

      - name: Run API tests
        run: go test -timeout 120s ./...
        working-directory: api
        env:
          GOPRIVATE: github.com/jmylchreest/*

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        run: npm ci
        working-directory: web

      - name: Lint web
        run: npm run lint
        working-directory: web

  # Build OpenAPI spec using refyne-openapi binary
  build-openapi:
    name: Build OpenAPI Spec
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git for private modules
        run: git config --global url."https://x-access-token:${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: api/go.sum

      - name: Build refyne-openapi
        run: go build -o refyne-openapi ./cmd/refyne-openapi
        working-directory: api
        env:
          GOPRIVATE: github.com/jmylchreest/*

      - name: Generate OpenAPI spec
        run: ./refyne-openapi -output openapi.json
        working-directory: api

      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: api/openapi.json
          retention-days: 1

  # Deploy API to Fly.io
  deploy-api:
    name: Deploy API (${{ needs.prepare.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [prepare, test]
    environment:
      name: ${{ needs.prepare.outputs.environment }}
      url: ${{ needs.prepare.outputs.api_url }}
    defaults:
      run:
        working-directory: api

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        uses: jmylchreest/gha-extract-git-version@v1

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@1.5

      - name: Deploy to Fly.io
        run: |
          flyctl deploy --remote-only \
            --app ${{ needs.prepare.outputs.api_app }} \
            --config fly.${{ needs.prepare.outputs.environment }}.toml \
            --build-secret GH_TOKEN=${{ secrets.GH_PAT }} \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT=${{ steps.version.outputs.sha }} \
            --build-arg DATE=${{ steps.version.outputs.date }} \
            --build-arg DIRTY=${{ steps.version.outputs.dirty }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10
          flyctl status --app ${{ needs.prepare.outputs.api_app }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # Deploy Web to Cloudflare Pages (SSR via OpenNext)
  deploy-web:
    name: Deploy Web (${{ needs.prepare.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [prepare, build-openapi, deploy-api]
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
    environment:
      name: ${{ needs.prepare.outputs.environment }}-web
      url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Download OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: web

      - name: Install dependencies
        run: npm ci
        working-directory: web

      - name: Build with OpenNext
        run: npm run build:cloudflare
        working-directory: web
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.prepare.outputs.api_url }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.CLERK_PUBLISHABLE_KEY }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        run: npx opennextjs-cloudflare deploy --project-name=${{ needs.prepare.outputs.web_project }}
        working-directory: web
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # Post-deployment notification
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, deploy-api, deploy-web]
    if: always() && (needs.deploy-api.result == 'success' || needs.deploy-web.result == 'success')
    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API:** ${{ needs.prepare.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web:** ${{ needs.deploy-web.outputs.url || needs.prepare.outputs.web_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.deploy-web.result }} |" >> $GITHUB_STEP_SUMMARY
